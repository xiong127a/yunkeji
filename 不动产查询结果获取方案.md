# 大数据查询结果获取方案

## 问题分析

如果使用简单的 `while(true)` 循环轮询，会导致：
- ❌ **线程阻塞**：每个查询占用一个线程，查询多了线程池会耗尽
- ❌ **资源浪费**：即使没有结果也在不断请求
- ❌ **服务器压力**：频繁请求第三方接口
- ❌ **服务停止时回调丢失**：如果服务停止，回调无法接收

## 最终方案：回调 + 定时任务兜底（✅ 已实现）

### 主方案：回调机制

**原理**：第三方系统查询完成后，主动调用我们的回调接口通知结果

**优点**：
- ✅ 实时性好，结果一出来就通知
- ✅ 不占用线程，异步处理
- ✅ 不浪费资源

**实现**：
1. 提交查询时，自动设置 `callBackUrl`（配置在 `application.yml` 中）
2. 第三方系统查询完成后，会调用回调地址：`/api/callback/real-estate`
3. 回调接口接收结果并更新数据库状态

**代码位置**：
- 回调接口：`RealEstateCallbackController.java`
- 回调处理：`UserManagementServiceImpl.handleRealEstateCallback()`
- 提交查询时设置回调地址：`UserManagementServiceImpl.submitRealEstateQuery()`

---

### 兜底方案：定时任务

**原理**：定时任务查询那些长时间没有收到回调的记录，避免回调丢失

**优点**：
- ✅ 只用一个线程，不会线程爆炸
- ✅ 可以批量处理，效率高
- ✅ 解决服务停止时回调丢失的问题

**实现**：
1. 定时任务每 **10分钟** 执行一次
2. 只查询那些：
   - 状态为 `SUBMITTED` 或 `PROCESSING`
   - 有 `requestNo`
   - **超过30分钟未更新**的记录
3. 调用第三方接口查询结果
4. 更新数据库状态

**代码位置**：
- 定时任务：`RealEstateQueryScheduler.java`
- 已启用：`BootApplication.java` 添加了 `@EnableScheduling`

---

## 工作流程

```
用户提交查询
    ↓
保存记录（状态：SUBMITTED，requestNo：xxx）
    ↓
调用第三方接口，传入 callBackUrl
    ↓
    ├─→ 正常情况：第三方系统查询完成后调用回调接口
    │                    ↓
    │              更新记录状态（COMPLETED/REJECTED）
    │
    └─→ 异常情况：服务停止或回调丢失
                         ↓
                    定时任务兜底（每10分钟检查一次）
                         ↓
                    查询超过30分钟未更新的记录
                         ↓
                    调用第三方接口查询结果
                         ↓
                    更新记录状态
```

---

## 配置说明

在 `application.yml` 中配置：

```yaml
real:
  estate:
    api:
      url: http://8.137.70.50:81
    access:
      key: accessKey
    secret: 
      key: secretKey
    # 回调地址（需要配置为公网可访问的地址）
    callback-url: https://your-domain.com/yunkeji/api/callback/real-estate
```

**重要**：
- `callback-url` 必须是**公网可访问**的地址
- 如果服务在内网，需要使用内网穿透或反向代理
- 回调地址需要在第三方系统中配置白名单

---

## 状态流转

```
SUBMITTED (已提交)
    ↓
    ├─→ 回调通知 → PROCESSING (处理中) → COMPLETED (已完成)
    │                    ↓
    │                REJECTED (审核不通过)
    │
    └─→ 定时任务兜底（超过30分钟未更新）
                         ↓
                    PROCESSING (处理中)
                         ↓
                    COMPLETED/REJECTED/FAILED
```

---

## 优势总结

1. **实时性**：回调机制保证结果第一时间通知
2. **可靠性**：定时任务兜底，即使服务停止或回调丢失也能恢复
3. **资源效率**：只用一个线程做定时任务，不会线程爆炸
4. **容错性**：双重保障，确保查询结果不丢失

---

## 配置建议

```yaml
real-estate:
  # 回调地址（需要配置为公网可访问的地址）
  callback-url: https://your-domain.com/api/callback/real-estate
  
  # 定时任务配置
  scheduler:
    enabled: true
    interval: 300000  # 5分钟轮询一次
    timeout: 2592000000  # 30天超时
    
  # 前端轮询配置
  frontend-polling:
    interval: 30000  # 30秒
    max-times: 60  # 最多60次（30分钟）
```

---

## 状态流转

```
SUBMITTED (已提交)
    ↓
    ├─→ 回调通知 → PROCESSING (处理中)
    │                    ↓
    │                COMPLETED (已完成)
    │
    └─→ 定时任务轮询 → PROCESSING (处理中)
                         ↓
                     COMPLETED (已完成)
```

