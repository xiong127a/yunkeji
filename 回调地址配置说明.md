# 回调地址配置说明

## 回调地址的作用

当用户提交大数据查询后，第三方系统会在查询完成后主动调用我们配置的回调地址，通知查询结果。这样可以：
- ✅ 实时接收查询结果，无需轮询
- ✅ 减少服务器压力
- ✅ 提高响应速度

## 回调地址配置

### 1. 配置文件位置

在 `yunkeji-boot/src/main/resources/application.yml` 中配置：

```yaml
real:
  estate:
    callback-url: http://your-domain:8080/yunkeji/api/callback/real-estate
```

### 2. 回调地址格式

**完整格式**：`http://域名或IP:端口/yunkeji/api/callback/real-estate`

**说明**：
- `http://your-domain:8080` - 你的服务器地址和端口
- `/yunkeji` - 后端配置的 context-path
- `/api/callback/real-estate` - 回调接口路径

### 3. 配置示例

#### 本地开发环境（内网穿透）
```yaml
real:
  estate:
    callback-url: http://your-ngrok-domain.ngrok.io/yunkeji/api/callback/real-estate
```

#### 生产环境
```yaml
real:
  estate:
    callback-url: https://your-domain.com/yunkeji/api/callback/real-estate
```

#### 内网环境（需要配置反向代理）
```yaml
real:
  estate:
    callback-url: http://your-public-ip:8080/yunkeji/api/callback/real-estate
```

## 回调接口说明

### 接口路径
`POST /yunkeji/api/callback/real-estate`

### 接口实现
- **控制器**：`RealEstateCallbackController.java`
- **处理方法**：`handleCallback()`
- **日志记录**：所有回调请求都会记录日志

### 回调数据格式
第三方系统会发送 JSON 格式的数据，包含：
- `reqNo` 或 `requestNo` - 查询请求编号
- `approvalStatus` - 审核状态
- `authResults` - 认证结果
- 其他查询结果数据

## 验证回调地址

### 1. 检查日志输出

提交查询时，查看后端日志，应该能看到：
```
设置回调地址: http://your-domain:8080/yunkeji/api/callback/real-estate
提交查询请求，回调地址: http://your-domain:8080/yunkeji/api/callback/real-estate
```

### 2. 测试回调接口

可以使用 Postman 或 curl 测试回调接口：

```bash
curl -X POST http://localhost:8080/yunkeji/api/callback/real-estate \
  -H "Content-Type: application/json" \
  -d '{
    "reqNo": "test123",
    "approvalStatus": "APPROVED",
    "authResults": [{
      "authState": "30"
    }]
  }'
```

### 3. 检查回调日志

当第三方系统调用回调接口时，后端日志会显示：
```
收到大数据查询结果回调: {...}
成功处理回调，更新查询记录 ID=xxx, requestNo=xxx, status=COMPLETED
```

## 常见问题

### 1. 回调地址未配置

**现象**：日志显示 "回调地址未配置，第三方系统将无法主动回调结果"

**解决**：在 `application.yml` 中配置 `real.estate.callback-url`

### 2. 回调地址无法访问

**原因**：
- 服务器未启动
- 防火墙阻止了外部访问
- 回调地址配置错误

**解决**：
- 确保服务器运行在配置的地址和端口
- 检查防火墙设置，开放 8080 端口（或你配置的端口）
- 验证回调地址格式是否正确

### 3. 回调接口返回错误

**检查**：
- 查看后端日志中的错误信息
- 确认回调数据格式是否正确
- 检查数据库连接是否正常

## 注意事项

1. **公网访问**：回调地址必须是第三方系统可以访问的公网地址
2. **HTTPS**：生产环境建议使用 HTTPS
3. **白名单**：某些第三方系统可能需要配置回调地址白名单
4. **超时设置**：确保回调接口响应时间在合理范围内
5. **兜底机制**：即使回调失败，定时任务也会定期查询结果（每10分钟）

## 相关文件

- 回调接口：`yunkeji-web/src/main/java/org/yun/web/controller/RealEstateCallbackController.java`
- 回调处理：`yunkeji-service-impl/src/main/java/org/yun/service/impl/UserManagementServiceImpl.java`
- 配置文件：`yunkeji-boot/src/main/resources/application.yml`
- 定时任务（兜底）：`yunkeji-service-impl/src/main/java/org/yun/service/impl/RealEstateQueryScheduler.java`














